name: Deploy Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

jobs:
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate deployment parameters
        id: validate
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
          DEPLOY_VERSION: ${{ github.event.inputs.version || 'latest' }}
        run: |
          echo "Environment: $DEPLOY_ENV"
          echo "Version: $DEPLOY_VERSION"
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Check deployment windows
        if: github.event.inputs.environment == 'production'
        run: |
          HOUR=$(date +%H)
          DAY=$(date +%u)
          if [[ $DAY -ge 6 ]] || [[ $HOUR -lt 9 ]] || [[ $HOUR -gt 17 ]]; then
            echo "::warning::Deploying outside business hours"
          fi

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: needs.validate-deployment.outputs.proceed == 'true'
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure environment variables
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          case "$DEPLOY_ENV" in
            development)
              echo "API_URL=https://api-dev.waardhaven.com" >> $GITHUB_ENV
              echo "WEB_URL=https://dev.waardhaven.com" >> $GITHUB_ENV
              ;;
            staging)
              echo "API_URL=https://api-staging.waardhaven.com" >> $GITHUB_ENV
              echo "WEB_URL=https://staging.waardhaven.com" >> $GITHUB_ENV
              ;;
            production)
              echo "API_URL=https://api.waardhaven.com" >> $GITHUB_ENV
              echo "WEB_URL=https://waardhaven.com" >> $GITHUB_ENV
              ;;
          esac

      - name: Deploy database migrations
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Running database migrations for $DEPLOY_ENV"
          # Add migration commands here

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy API to environment
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
          DEPLOY_VERSION: ${{ github.event.inputs.version || 'latest' }}
        run: |
          echo "Deploying API version $DEPLOY_VERSION to $DEPLOY_ENV"
          # Add deployment commands here

      - name: Health check
        run: |
          echo "Running health checks on API"
          # curl -f ${{ env.API_URL }}/health || exit 1

      - name: Run smoke tests
        run: |
          echo "Running API smoke tests"
          # Add smoke test commands

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Web to environment
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
          DEPLOY_VERSION: ${{ github.event.inputs.version || 'latest' }}
        run: |
          echo "Deploying Web version $DEPLOY_VERSION to $DEPLOY_ENV"
          # Add deployment commands here

      - name: Health check
        run: |
          echo "Running health checks on Web"
          # curl -f ${{ env.WEB_URL }} || exit 1

      - name: Run smoke tests
        run: |
          echo "Running Web smoke tests"
          # Add smoke test commands

  post-deployment:
    name: Post Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Run integration tests
        if: success()
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Running integration tests on $DEPLOY_ENV"
          # Add integration test commands

      - name: Update deployment tracking
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Recording deployment to $DEPLOY_ENV"
          # Add deployment tracking commands

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment to ${{ github.event.inputs.environment }} ${{ job.status }}
            Version: ${{ github.event.inputs.version || 'latest' }}
            Triggered by: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: post-deployment
    if: failure()
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Initiate rollback
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "Rolling back deployment on $DEPLOY_ENV"
          # Add rollback commands

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "⚠️ Rollback initiated for ${{ github.event.inputs.environment }} environment"
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}